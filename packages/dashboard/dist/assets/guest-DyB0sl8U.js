import{r as i,j as e,a as p,c as C}from"./index-Bd1r4d6-.js";import{E as A,n as k,h as H,e as L}from"./EntityCard-CfYf4tip.js";function R({name:t,icon:c,entityIds:n,defaultExpanded:r=!0,showEntityActions:l=!1,onHideEntity:u,onGearClick:h,entityProps:s}){const[o,g]=i.useState(r);return n.length===0?null:e.jsxs("div",{className:"module-section",children:[e.jsxs("div",{className:"module-header",onClick:()=>g(!o),children:[e.jsxs("h2",{children:[e.jsx("span",{children:c}),t,e.jsxs("span",{style:{fontSize:"0.8rem",color:"var(--text-muted)",fontWeight:400},children:["(",n.length,")"]})]}),e.jsx("button",{type:"button",className:`module-toggle ${o?"":"collapsed"}`,"aria-label":o?"Collapse":"Expand",children:"â–¼"})]}),o&&e.jsx("div",{className:"module-entities",children:n.map(a=>{var m,d,f,x,N,S,v;return e.jsx(A,{entityId:a,showActions:l,onHide:u,onGearClick:h,customName:(m=s==null?void 0:s[a])==null?void 0:m.custom_name,customIcon:(d=s==null?void 0:s[a])==null?void 0:d.custom_icon,showLastUpdated:(f=s==null?void 0:s[a])==null?void 0:f.show_last_updated,hideState:(x=s==null?void 0:s[a])==null?void 0:x.hide_state,hideUpdated:(N=s==null?void 0:s[a])==null?void 0:N.hide_updated,hideAttributes:(S=s==null?void 0:s[a])==null?void 0:S.hide_attributes,hideLogbook:(v=s==null?void 0:s[a])==null?void 0:v.hide_logbook},a)})})]})}function _(){const t=k(n=>n.connectionStatus),c=t==="connected"?"connected":"error";return e.jsx("div",{className:`status ${c}`,children:t==="connected"?"connected":"not connected"})}function D(){const[t,c]=i.useState([]),[n,r]=i.useState("LobbyHA"),[l,u]=i.useState(!0),[h,s]=i.useState({});return i.useEffect(()=>{let o=!0;return(async()=>{try{const[a,m,d]=await Promise.all([p("/api/ui/guest-entities"),p("/api/ui/guest-modules"),p("/api/ui/guest-entity-props")]);if(!o)return;r(a.title||"LobbyHA"),c(m.modules);const f={};for(const x of d.props)f[x.entity_id]=x;s(f)}catch{}finally{o&&u(!1)}})(),()=>{o=!1}},[]),l?e.jsx("div",{className:"container",children:e.jsx("p",{className:"note",children:"Loading..."})}):e.jsxs("div",{className:"guest-layout",children:[e.jsxs("header",{className:"guest-header",children:[e.jsx("h1",{className:"dashboard-title",children:n}),e.jsx(_,{})]}),e.jsx("main",{className:"guest-main",children:t.length===0?e.jsx("div",{className:"empty-state",children:e.jsx("p",{children:"No areas configured yet. Ask the admin to set up the dashboard."})}):t.map(o=>e.jsx(R,{name:o.name,icon:o.icon,entityIds:o.entities,entityProps:h},o.id))})]})}function M({onAuthenticated:t}){const[c,n]=i.useState(""),[r,l]=i.useState(null),[u,h]=i.useState(!1),s=i.useRef(null);i.useEffect(()=>{var a;(a=s.current)==null||a.focus()},[]);const o=async()=>{var a;if(c.trim()){h(!0),l(null);try{const d=await(await fetch("/api/guest/verify-pin",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({pin:c.trim()})})).json();d.success&&d.guestSessionId?t(d.guestSessionId):(l(d.error||"Invalid PIN"),n(""),(a=s.current)==null||a.focus())}catch{l("Connection error. Please try again.")}finally{h(!1)}}},g=a=>{a.key==="Enter"&&o()};return e.jsx("div",{className:"pin-gate",children:e.jsxs("div",{className:"pin-card",children:[e.jsx("h1",{className:"pin-title",children:"ðŸ "}),e.jsx("h2",{className:"pin-subtitle",children:"Enter PIN to continue"}),e.jsx("input",{ref:s,className:"pin-input",type:"password",inputMode:"numeric",pattern:"[0-9]*",maxLength:10,value:c,onChange:a=>n(a.target.value),onKeyDown:g,placeholder:"â€¢ â€¢ â€¢ â€¢",disabled:u,autoComplete:"off"}),r&&e.jsx("p",{className:"pin-error",children:r}),e.jsx("button",{type:"button",className:"pin-submit",onClick:o,disabled:u||!c.trim(),children:u?"Verifying...":"Enter"})]})})}const b="guestSessionId";let j=localStorage.getItem(b);function y(t){j=t,localStorage.setItem(b,t)}function G(){j=null,localStorage.removeItem(b)}function w(){const t=window.fetch;window.fetch=function(c,n){if(j){const r=new Headers(n==null?void 0:n.headers);return r.has("X-Guest-Session")||r.set("X-Guest-Session",j),t.call(this,c,{...n,headers:r})}return t.call(this,c,n)}}async function U(){const t=C.createRoot(document.getElementById("root"));j&&w();try{const n=await(await fetch("/api/guest/status")).json();if(n.pinEnabled&&!n.authenticated){G(),t.render(e.jsx(i.StrictMode,{children:e.jsx(M,{onAuthenticated:r=>{y(r),w(),E(t)}})}));return}E(t)}catch{t.render(e.jsx(i.StrictMode,{children:e.jsxs("div",{className:"container",children:[e.jsx("h1",{children:"LobbyHA"}),e.jsx("p",{className:"note error",children:"Failed to connect to server."}),e.jsx("button",{type:"button",className:"action-button",onClick:()=>window.location.reload(),children:"Retry"})]})}))}}async function E(t){try{let c="",n="";const r=await fetch("/api/config");if(r.ok){const l=await r.json();c=l.hassUrl||l.haUrl||"",n=l.hassToken||""}if(!c){t.render(e.jsx(i.StrictMode,{children:e.jsxs("div",{className:"container",children:[e.jsx("h1",{children:"LobbyHA"}),e.jsx("p",{className:"note",children:"Dashboard not configured yet."}),e.jsx("a",{href:"/setup",className:"action-button",children:"Run Setup"})]})}));return}t.render(e.jsx(i.StrictMode,{children:e.jsxs(H,{hassUrl:c,hassToken:n,loading:e.jsx("div",{className:"container",children:e.jsx("p",{className:"note",children:"Connecting to Home Assistant..."})}),options:{renderError:()=>e.jsxs("div",{className:"container",children:[e.jsx("h1",{children:"LobbyHA"}),e.jsxs("p",{className:"note error",children:["Unable to connect to Home Assistant.",e.jsx("br",{}),"Make sure HA is running and the server config is correct."]}),e.jsxs("div",{style:{display:"flex",gap:"1rem",justifyContent:"center"},children:[e.jsx("button",{type:"button",className:"action-button",onClick:()=>window.location.reload(),children:"Retry"}),e.jsx("a",{href:"/admin",className:"action-button secondary",children:"Admin Settings"})]})]})},children:[e.jsx(L,{}),e.jsx(D,{})]})}))}catch{t.render(e.jsx(i.StrictMode,{children:e.jsxs("div",{className:"container",children:[e.jsx("h1",{children:"LobbyHA"}),e.jsx("p",{className:"note error",children:"Failed to connect to server."}),e.jsx("button",{type:"button",className:"action-button",onClick:()=>window.location.reload(),children:"Retry"})]})}))}}U();
