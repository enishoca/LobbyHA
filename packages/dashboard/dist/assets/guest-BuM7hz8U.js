import{r as o,j as e,a as x,c as j}from"./index-DB0qu6yo.js";import{E as y,n as b,h as g,e as N}from"./EntityCard-BQJr6hC3.js";function S({name:s,icon:n,entityIds:t,defaultExpanded:i=!0,showEntityActions:r=!1,onHideEntity:l}){const[a,u]=o.useState(i);return t.length===0?null:e.jsxs("div",{className:"module-section",children:[e.jsxs("div",{className:"module-header",onClick:()=>u(!a),children:[e.jsxs("h2",{children:[e.jsx("span",{children:n}),s,e.jsxs("span",{style:{fontSize:"0.8rem",color:"var(--text-muted)",fontWeight:400},children:["(",t.length,")"]})]}),e.jsx("button",{type:"button",className:`module-toggle ${a?"":"collapsed"}`,"aria-label":a?"Collapse":"Expand",children:"â–¼"})]}),a&&e.jsx("div",{className:"module-entities",children:t.map(d=>e.jsx(y,{entityId:d,showActions:r,onHide:l},d))})]})}function v(){const s=b(t=>t.connectionStatus),n=s==="connected"?"connected":"error";return e.jsx("div",{className:`status ${n}`,children:s==="connected"?"connected":"not connected"})}function w(){const[s,n]=o.useState([]),[t,i]=o.useState("LobbyHA"),[r,l]=o.useState(!0);return o.useEffect(()=>{let a=!0;return(async()=>{try{const[d,m]=await Promise.all([x("/api/ui/guest-entities"),x("/api/ui/guest-modules")]);if(!a)return;i(d.title||"LobbyHA"),n(m.modules)}catch{}finally{a&&l(!1)}})(),()=>{a=!1}},[]),r?e.jsx("div",{className:"container",children:e.jsx("p",{className:"note",children:"Loading..."})}):e.jsxs("div",{className:"guest-layout",children:[e.jsxs("header",{className:"guest-header",children:[e.jsx("h1",{className:"dashboard-title",children:t}),e.jsx(v,{})]}),e.jsx("main",{className:"guest-main",children:s.length===0?e.jsx("div",{className:"empty-state",children:e.jsx("p",{children:"No areas configured yet. Ask the admin to set up the dashboard."})}):s.map(a=>e.jsx(S,{name:a.name,icon:a.icon,entityIds:a.entities},a.id))})]})}function C({onAuthenticated:s}){const[n,t]=o.useState(""),[i,r]=o.useState(null),[l,a]=o.useState(!1),u=o.useRef(null);o.useEffect(()=>{var c;(c=u.current)==null||c.focus()},[]);const d=async()=>{var c;if(n.trim()){a(!0),r(null);try{const h=await(await fetch("/api/guest/verify-pin",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({pin:n.trim()})})).json();h.success&&h.guestSessionId?s(h.guestSessionId):(r(h.error||"Invalid PIN"),t(""),(c=u.current)==null||c.focus())}catch{r("Connection error. Please try again.")}finally{a(!1)}}},m=c=>{c.key==="Enter"&&d()};return e.jsx("div",{className:"pin-gate",children:e.jsxs("div",{className:"pin-card",children:[e.jsx("h1",{className:"pin-title",children:"ðŸ "}),e.jsx("h2",{className:"pin-subtitle",children:"Enter PIN to continue"}),e.jsx("input",{ref:u,className:"pin-input",type:"password",inputMode:"numeric",pattern:"[0-9]*",maxLength:10,value:n,onChange:c=>t(c.target.value),onKeyDown:m,placeholder:"â€¢ â€¢ â€¢ â€¢",disabled:l,autoComplete:"off"}),i&&e.jsx("p",{className:"pin-error",children:i}),e.jsx("button",{type:"button",className:"pin-submit",onClick:d,disabled:l||!n.trim(),children:l?"Verifying...":"Enter"})]})})}let p=null;function E(){const s=window.fetch;window.fetch=function(n,t){if(p){const i=new Headers(t==null?void 0:t.headers);return i.has("X-Guest-Session")||i.set("X-Guest-Session",p),s.call(this,n,{...t,headers:i})}return s.call(this,n,t)}}async function A(){const s=j.createRoot(document.getElementById("root"));try{const t=await(await fetch("/api/guest/status")).json();if(t.pinEnabled&&!t.authenticated){s.render(e.jsx(o.StrictMode,{children:e.jsx(C,{onAuthenticated:i=>{p=i,E(),f(s)}})}));return}f(s)}catch{s.render(e.jsx(o.StrictMode,{children:e.jsxs("div",{className:"container",children:[e.jsx("h1",{children:"LobbyHA"}),e.jsx("p",{className:"note error",children:"Failed to connect to server."}),e.jsx("button",{type:"button",className:"action-button",onClick:()=>window.location.reload(),children:"Retry"})]})}))}}async function f(s){try{let n="",t="";const i=await fetch("/api/config");if(i.ok){const r=await i.json();n=r.hassUrl||r.haUrl||"",t=r.hassToken||""}if(!n){s.render(e.jsx(o.StrictMode,{children:e.jsxs("div",{className:"container",children:[e.jsx("h1",{children:"LobbyHA"}),e.jsx("p",{className:"note",children:"Dashboard not configured yet."}),e.jsx("a",{href:"/setup",className:"action-button",children:"Run Setup"})]})}));return}s.render(e.jsx(o.StrictMode,{children:e.jsxs(g,{hassUrl:n,hassToken:t,loading:e.jsx("div",{className:"container",children:e.jsx("p",{className:"note",children:"Connecting to Home Assistant..."})}),options:{renderError:()=>e.jsxs("div",{className:"container",children:[e.jsx("h1",{children:"LobbyHA"}),e.jsxs("p",{className:"note error",children:["Unable to connect to Home Assistant.",e.jsx("br",{}),"Make sure HA is running and the server config is correct."]}),e.jsxs("div",{style:{display:"flex",gap:"1rem",justifyContent:"center"},children:[e.jsx("button",{type:"button",className:"action-button",onClick:()=>window.location.reload(),children:"Retry"}),e.jsx("a",{href:"/admin",className:"action-button secondary",children:"Admin Settings"})]})]})},children:[e.jsx(N,{}),e.jsx(w,{})]})}))}catch{s.render(e.jsx(o.StrictMode,{children:e.jsxs("div",{className:"container",children:[e.jsx("h1",{children:"LobbyHA"}),e.jsx("p",{className:"note error",children:"Failed to connect to server."}),e.jsx("button",{type:"button",className:"action-button",onClick:()=>window.location.reload(),children:"Retry"})]})}))}}A();
